<!-- filename: tomato-calendar.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tomato Calendar Generator (Brussels)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; line-height: 1.5; }
    h1 { margin-bottom: 0.5rem; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-top: 1rem; max-width: 760px; }
    label { display: block; margin: 0.5rem 0 0.25rem; font-weight: 600; }
    input, select { width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ccc; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    button { margin-top: 1rem; padding: 0.75rem 1rem; border: none; border-radius: 8px; background: #e53935; color: white; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    small { color: #555; }
    ul { margin: 0.5rem 0 0; padding-left: 1.1rem; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <h1>Tomato Calendar Generator</h1>
  <p class="muted">Creates an iCal (.ics) with planting, watering, and harvest events for Europe/Brussels.</p>

  <div class="card">
    <div class="row">
      <div>
        <label for="plantingDate">Transplanting date (Europe/Brussels)</label>
        <input type="date" id="plantingDate" />
        <small>Typical Brussels transplant: mid–May (after last frost, nights ≥ 10–15°C).</small>
      </div>
      <div>
        <label for="varietyDays">Variety maturity (days)</label>
        <input type="number" id="varietyDays" min="50" max="100" step="1" value="70" />
        <small>Early: 55–65; Mainseason: 70–80; Late: 80–90.</small>
      </div>
    </div>

    <label for="wateringIntensity">Watering plan</label>
    <select id="wateringIntensity">
      <option value="standard" selected>Standard (beds)</option>
      <option value="container">Container (dries faster)</option>
      <option value="drySpell">Dry spell prone</option>
    </select>

    <button id="generateBtn">Generate .ics</button>

    <div id="preview"></div>
  </div>

  <script>
    // Utility: date handling in local time (Europe/Brussels) but ICS must be UTC or with TZID.
    // We'll keep it simple: make events all-day (no time zone ambiguity) + some morning 08:00 events with Europe/Brussels TZ text blocks.

    function fmtDateYYYYMMDD(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}${m}${d}`;
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function dtStamp() {
      const now = new Date();
      const y = now.getUTCFullYear();
      const m = String(now.getUTCMonth() + 1).padStart(2, '0');
      const d = String(now.getUTCDate()).padStart(2, '0');
      const hh = String(now.getUTCHours()).padStart(2, '0');
      const mm = String(now.getUTCMinutes()).padStart(2, '0');
      const ss = String(now.getUTCSeconds()).padStart(2, '0');
      return `${y}${m}${d}T${hh}${mm}${ss}Z`;
    }

    function uid() {
      return 'uid-' + Math.random().toString(36).slice(2) + '@tomato-calendar';
    }

    function makeAllDayEvent(summary, startDate, endDate, description = '') {
      const start = fmtDateYYYYMMDD(startDate);
      const end = fmtDateYYYYMMDD(endDate); // non-inclusive per RFC5545
      return [
        'BEGIN:VEVENT',
        `UID:${uid()}`,
        `DTSTAMP:${dtStamp()}`,
        `SUMMARY:${escapeText(summary)}`,
        `DESCRIPTION:${escapeText(description)}`,
        `DTSTART;VALUE=DATE:${start}`,
        `DTEND;VALUE=DATE:${end}`,
        'TRANSP:OPAQUE',
        'END:VEVENT'
      ].join('\\n');
    }

    function makeTimedEvent(summary, startDateTime, durationMinutes, description = '') {
      // Time in Europe/Brussels with TZID label; ICS consumers handle TZ definitions loosely, we’ll use TZID=Europe/Brussels
      const dtStart = fmtLocalDateTime(startDateTime);
      const dtEnd = fmtLocalDateTime(addMinutes(startDateTime, durationMinutes));
      return [
        'BEGIN:VEVENT',
        `UID:${uid()}`,
        `DTSTAMP:${dtStamp()}`,
        `SUMMARY:${escapeText(summary)}`,
        `DESCRIPTION:${escapeText(description)}`,
        `DTSTART;TZID=Europe/Brussels:${dtStart}`,
        `DTEND;TZID=Europe/Brussels:${dtEnd}`,
        'TRANSP:OPAQUE',
        'END:VEVENT'
      ].join('\\n');
    }

    function addMinutes(date, minutes) {
      const d = new Date(date);
      d.setMinutes(d.getMinutes() + minutes);
      return d;
    }

    function fmtLocalDateTime(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const hh = String(date.getHours()).padStart(2, '0');
      const mm = String(date.getMinutes()).padStart(2, '0');
      const ss = String(date.getSeconds()).padStart(2, '0');
      return `${y}${m}${d}T${hh}${mm}${ss}`;
    }

    function escapeText(str) {
      return String(str)
        .replace(/\\\\/g, '\\\\\\\\')
        .replace(/\\n/g, '\\\\n')
        .replace(/,/g, '\\\\,')
        .replace(/;/g, '\\\\;');
    }

    function buildICS(events) {
      const header = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Tomato Calendar//Europe/Brussels//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH'
      ].join('\\n');
      const footer = 'END:VCALENDAR';
      return [header, ...events, footer].join('\\n');
    }

    function defaultBrusselsTransplantYear() {
      const now = new Date();
      const y = now.getFullYear();
      // Typical transplant mid-May. If today is past May 31, default to next year May 15.
      const may15 = new Date(y, 4, 15);
      const may31 = new Date(y, 4, 31);
      if (now <= may31) return may15;
      return new Date(y + 1, 4, 15);
    }

    function stageSchedule(plantDate, maturityDays) {
      // Stage boundaries based on horticultural guidance:
      // - Establishment: 0–14 days
      // - Vegetative: 15–35 days
      // - Flower/Fruit set: 36–(maturityDays - 10)
      // - Ripening window: last 10 days before maturity
      const s = {};
      s.estStart = plantDate;
      s.estEnd = addDays(plantDate, 14);

      s.vegStart = addDays(plantDate, 15);
      s.vegEnd = addDays(plantDate, 35);

      const fruitStartOffset = 36;
      const ripeningDays = Math.max(10, Math.round(maturityDays * 0.15));
      const fruitEndOffset = maturityDays - ripeningDays;

      s.fruitStart = addDays(plantDate, fruitStartOffset);
      s.fruitEnd = addDays(plantDate, fruitEndOffset);

      s.ripenStart = addDays(plantDate, fruitEndOffset + 1);
      s.ripenEnd = addDays(plantDate, maturityDays);

      s.firstHarvestTarget = addDays(plantDate, fruitEndOffset); // first breaker likely here
      s.harvestWindowStart = addDays(plantDate, ripeningDays > 12 ? fruitEndOffset - 2 : fruitEndOffset);
      s.harvestWindowEnd = addDays(plantDate, maturityDays + 30); // continued harvest for indeterminate types
      return s;
    }

    function wateringCadence(intensity) {
      // Baseline per stage; we’ll convert to recurring reminders
      const plan = {
        standard: {
          establishment: { frequencyDays: 2, description: 'Deep soak at base; keep evenly moist. Morning preferred.' },
          vegetative:    { frequencyDays: 3, description: '1–2 deep waterings/week depending on rain. Aim for 2.5–5 cm/week.' },
          fruiting:      { frequencyDays: 3, description: 'Maintain consistent moisture; avoid swings.' },
          ripening:      { frequencyDays: 4, description: 'Slightly reduce watering to improve flavor and reduce cracking.' }
        },
        container: {
          establishment: { frequencyDays: 1, description: 'Containers dry fast—check daily. Morning preferred.' },
          vegetative:    { frequencyDays: 2, description: 'Often daily in hot weather; water when top 2–3 cm is dry.' },
          fruiting:      { frequencyDays: 2, description: 'Keep steady moisture; increase on heat waves.' },
          ripening:      { frequencyDays: 3, description: 'Slightly reduce watering for flavor; avoid full dry-down.' }
        },
        drySpell: {
          establishment: { frequencyDays: 2, description: 'Mulch + deep soak; consider shade cloth in extreme heat.' },
          vegetative:    { frequencyDays: 2, description: 'Increase volume to meet ~5 cm/week if little rain.' },
          fruiting:      { frequencyDays: 2, description: 'Consistent moisture to prevent blossom-end rot/cracking.' },
          ripening:      { frequencyDays: 3, description: 'Slight reduction; monitor for splitting after storms.' }
        }
      };
      return plan[intensity] || plan.standard;
    }

    function generateEvents(plantDate, maturityDays, intensity) {
      const tzMorningHour = 8; // 08:00 local
      const stages = stageSchedule(plantDate, maturityDays);
      const cadence = wateringCadence(intensity);

      const events = [];

      // Planting day (timed event)
      const plantTime = new Date(
        plantDate.getFullYear(),
        plantDate.getMonth(),
        plantDate.getDate(),
        tzMorningHour, 0, 0
      );
      events.push(
        makeTimedEvent(
          'Transplant Tomatoes',
          plantTime,
          60,
          'Plant deeply (bury 1/2–2/3 of stem). Mulch, stake/cage, water in well. Water at base, mornings preferred.'
        )
      );

      // Establishment window all-day
      events.push(
        makeAllDayEvent(
          'Establishment Phase',
          stages.estStart,
          addDays(stages.estEnd, 1),
          'Keep soil evenly moist. Avoid leaf wetting. Use drip/soaker if available.'
        )
      );

      // Vegetative window all-day
      events.push(
        makeAllDayEvent(
          'Vegetative Growth',
          stages.vegStart,
          addDays(stages.vegEnd, 1),
          'Train to stakes/cages; prune only as needed. Maintain deep, infrequent watering.'
        )
      );

      // Fruit set window all-day
      events.push(
        makeAllDayEvent(
          'Flowering & Fruit Set',
          stages.fruitStart,
          addDays(stages.fruitEnd, 1),
          'Consistent moisture. Avoid big swings. Consider light pruning for airflow.'
        )
      );

      // Ripening window all-day
      events.push(
        makeAllDayEvent(
          'Ripening',
          stages.ripenStart,
          addDays(stages.ripenEnd, 1),
          'Slightly reduce watering to improve flavor; watch for cracking.'
        )
      );

      // Watering reminders per stage (timed recurring-like via individual events)
      const wateringEvents = (start, end, summary, everyDays, desc) => {
        let cur = new Date(start);
        while (cur <= end) {
          const t = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate(), tzMorningHour, 0, 0);
          events.push(makeTimedEvent(summary, t, 30, desc));
          cur = addDays(cur, everyDays);
        }
      };

      wateringEvents(stages.estStart, stages.estEnd, 'Water Tomatoes — Establishment', cadence.establishment.frequencyDays, cadence.establishment.description);
      wateringEvents(stages.vegStart, stages.vegEnd, 'Water Tomatoes — Vegetative', cadence.vegetative.frequencyDays, cadence.vegetative.description);
      wateringEvents(stages.fruitStart, stages.fruitEnd, 'Water Tomatoes — Fruiting', cadence.fruiting.frequencyDays, cadence.fruiting.description);
      wateringEvents(stages.ripenStart, stages.ripenEnd, 'Water Tomatoes — Ripening', cadence.ripening.frequencyDays, cadence.ripening.description);

      // Mulch/stake/prune checkpoints
      events.push(makeTimedEvent('Mulch & Stake Check', addMinutes(plantTime, 24 * 60 * 7), 30, 'Top up mulch, ensure ties/supports.'));
      events.push(makeTimedEvent('Airflow & Disease Check', addMinutes(plantTime, 24 * 60 * 21), 30, 'Remove low leaves touching soil; inspect for spots.'));
      events.push(makeTimedEvent('Fertilize (if using)', addMinutes(plantTime, 24 * 60 * 28), 30, 'Light side-dress if needed; avoid over-fertilizing nitrogen.'));

      // Harvest reminders
      const firstBreakerMorning = new Date(stages.firstHarvestTarget.getFullYear(), stages.firstHarvestTarget.getMonth(), stages.firstHarvestTarget.getDate(), tzMorningHour, 0, 0);
      events.push(makeTimedEvent('Start Harvest Checks (Breaker Stage)', firstBreakerMorning, 30, 'Pick at breaker stage (first blush) to avoid splitting/pests.'));
      // Ongoing harvest every 3 days for a month after maturity
      let hCur = new Date(stages.harvestWindowStart);
      while (hCur <= stages.harvestWindowEnd) {
        const ht = new Date(hCur.getFullYear(), hCur.getMonth(), hCur.getDate(), tzMorningHour, 0, 0);
        events.push(makeTimedEvent('Harvest Tomatoes', ht, 45, 'Pick ripe fruit; store at room temp. Avoid refrigeration for best flavor.'));
        hCur = addDays(hCur, 3);
      }

      return events;
    }

    function downloadICS(filename, content) {
      const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        a.remove();
      }, 0);
    }

    // Initialize default date to next sensible Brussels transplant
    const plantingInput = document.getElementById('plantingDate');
    const defaultDate = defaultBrusselsTransplantYear();
    plantingInput.value = defaultDate.toISOString().slice(0, 10);

    document.getElementById('generateBtn').addEventListener('click', () => {
      const plantDateStr = plantingInput.value;
      if (!plantDateStr) {
        alert('Please choose a transplanting date.');
        return;
      }
      const plantDate = new Date(plantDateStr + 'T00:00:00');
      const maturityDays = parseInt(document.getElementById('varietyDays').value, 10) || 70;
      const intensity = document.getElementById('wateringIntensity').value;

      const events = generateEvents(plantDate, maturityDays, intensity);
      const ics = buildICS(events);
      downloadICS('tomato-calendar.ics', ics);

      document.getElementById('preview').innerHTML = '<small>Generated ' + events.length + ' events. Your download should begin automatically.</small>';
    });
  </script>
</body>
</html>
